
name: Process Form Submission

on:
  repository_dispatch:
    types: [form_submission]

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Process Form Submission
        run: |
          mkdir -p data
          
          # Create data file if it doesn't exist
          if [ ! -f "data/submissions.json" ]; then
            echo '{"metadata":{"lastUpdated":"","totalSubmissions":0},"submissions":[]}' > data/submissions.json
          fi
          
          # Parse submission from dispatch payload
          SUBMISSION='${{ toJson(github.event.client_payload.submission) }}'
          
          # Read existing data
          DATA=$(cat data/submissions.json)
          
          # Update metadata and add submission
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('data/submissions.json', 'utf8'));
            const submission = JSON.parse('${{ toJson(github.event.client_payload.submission) }}');
            
            // Update metadata
            data.metadata.lastUpdated = new Date().toISOString();
            data.metadata.totalSubmissions = (data.submissions.length || 0) + 1;
            
            // Add submission to array
            data.submissions.push(submission);
            
            // Write updated data back to file
            fs.writeFileSync('data/submissions.json', JSON.stringify(data, null, 2));
            
            console.log('Submission added successfully');
          "

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add data/submissions.json
          git commit -m "Add new form submission [automated]"
          git push
        env:
          GH_TOKEN: ${{ secrets.GH_FORM_TOKEN }}
